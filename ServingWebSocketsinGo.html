<html><head><title>Serving Web Sockets in Go</title><style type="text/css">ol{margin:0;padding:0}.c8{vertical-align:top;width:468pt;border-style:solid;border-color:#000000;border-width:1pt;padding:5pt 5pt 5pt 5pt}.c13{list-style-type:decimal;margin:0;padding:0}.c7{list-style-type:disc;margin:0;padding:0}.c12{max-width:468pt;background-color:#ffffff;padding:72pt 72pt 72pt 72pt}.c10{color:#1155cc;text-decoration:underline}.c5{padding-left:0pt;margin-left:36pt}.c9{color:inherit;text-decoration:inherit}.c4{height:11pt}.c0{direction:ltr}.c6{text-indent:36pt}.c1{font-family:"Courier New"}.c2{line-height:1.0}.c3{border-collapse:collapse}.c11{font-size:12pt}.title{padding-top:24pt;line-height:1.15;text-align:left;color:#000000;font-size:36pt;font-family:"Arial";font-weight:bold;padding-bottom:6pt}.subtitle{padding-top:18pt;line-height:1.15;text-align:left;color:#666666;font-style:italic;font-size:24pt;font-family:"Georgia";padding-bottom:4pt}p{color:#000000;font-size:11pt;margin:0;font-family:"Arial"}h1{padding-top:24pt;line-height:1.15;text-align:left;color:#000000;font-size:18pt;font-family:"Arial";font-weight:bold;padding-bottom:6pt}h2{padding-top:18pt;line-height:1.15;text-align:left;color:#000000;font-size:14pt;font-family:"Arial";font-weight:bold;padding-bottom:4pt}h3{padding-top:14pt;line-height:1.15;text-align:left;color:#666666;font-size:12pt;font-family:"Arial";font-weight:bold;padding-bottom:4pt}h4{padding-top:12pt;line-height:1.15;text-align:left;color:#666666;font-style:italic;font-size:11pt;font-family:"Arial";padding-bottom:2pt}h5{padding-top:11pt;line-height:1.15;text-align:left;color:#666666;font-size:10pt;font-family:"Arial";font-weight:bold;padding-bottom:2pt}h6{padding-top:10pt;line-height:1.15;text-align:left;color:#666666;font-style:italic;font-size:10pt;font-family:"Arial";padding-bottom:2pt}</style></head><body class="c12"><p class="c0 title"><a name="h.a1axs75g4k13"></a><span>Serving Web Sockets in Go</span></p><h1 class="c0"><a name="h.nl72x24jhsr9"></a><span>Introduction</span></h1><p class="c0"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p class="c0"><span>This is a tutorial that teaches how to use WebSocket. We will develop both sides, the web page and the server. The web page will consist of three files: HTML, JavaScript and CSS. The server side will be a program in Google&#39;s Go language.</span></p><h1 class="c0"><a name="h.qrvsfnw025lb"></a><span>Why Go?</span></h1><p class="c0"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p class="c0"><span>There are many ways to create a web server that supports WebSocket, so I had to choose one. I could have done this in Ruby, Python, PHP, but I think the Go results in the simplest and probably close to the fastest way. It was also a good excuse for me to finally dive into learning Go.</span></p><p class="c0"><span>I hope that the result will not be a program that is too hard to understand for a non-Go programmer. I will try to explain how it works, but for a bigger picture you should refer to one of the references on the web.</span></p><h1 class="c0"><a name="h.s0cx7k9hx91h"></a><span>Prerequisites</span></h1><p class="c0"><span>You should be able to read HTML, some very basic CSS and JavaScript. You should know some jQuery, because it is used to make the JavaScript simpler. You should be able to read Go. If you are not yet, know that it is easy to learn. In the next section you can see the references to sources I used to learn Go.</span></p><h1 class="c0"><a name="h.y8tpa4axa2sg"></a><span>References</span></h1><p class="c0"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><ol class="c7" start="1"><li class="c0 c5"><span>Go language main site</span><span><a class="c9" href="http://golang.org/">&nbsp;</a></span><span class="c10"><a class="c9" href="http://golang.org/">http://golang.org/</a></span></li><li class="c5 c0"><span>Jan Newmarch&#39;s Network Programming with Go &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c10"><a class="c9" href="http://jan.newmarch.name/go/">http://jan.newmarch.name/go/</a></span></li><li class="c5 c0"><span>Go WebSocket Example &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;https://gist.github.com/1316852</span></li></ol><p class="c4 c0"><span></span></p><h1 class="c0"><a name="h.9brux1rmhgvw"></a><span>Author</span></h1><p class="c0"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p class="c0"><span>The author of this document is Aleksandar Janicijevic. Now is May 16, 2012. Here is Toronto, Canada.</span></p><p class="c0"><span>Please forgive my bad HTML, CSS, JavaScript and Go (and English). I am no expert on these subjects, so feel free to take from this tutorial what you wish and make something better. That is what all tutorials are for.</span></p><p class="c0"><span>For comments (good or bad), errors, typos, and suggestions, I can be contacted at aleks@ajanicij.info.</span></p><h1 class="c0"><a name="h.pbcsbwpxi4ku"></a><span>Description</span></h1><p class="c0"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p class="c0"><span>We are going to go through steps of developing a web application that uses WebSocket to connect to any service just like telnet does. The user sitting at browser can specify any host and port and the application will attempt connecting to that service. If the connection is established, the user will be able to send text messages to the service and see its response. As a test, we will demonstrate how to connect to a web server such as google.com and get the home page. We will also develop a very simple echo server (local to our web server) and connect to it.</span></p><h1 class="c0"><a name="h.pi385h3rw3pc"></a><span>State of the World</span></h1><p class="c0"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p class="c0"><span>As I am writing this, the software and standards I use are at the following versions:</span></p><ol class="c7" start="1"><li class="c5 c0"><span>Go is at go1.0.1</span></li><li class="c5 c0"><span>Chrome browser is at 18.0.1025.168</span></li><li class="c5 c0"><span>Firefox is at 12.0 (but I am using 11.0 for Ubuntu 11.04 Natty Narwhal)</span></li><li class="c5 c0"><span>WebSocket is defined by May 8, 2012 editor&#39;s draft &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</span><span class="c10"><a class="c9" href="http://dev.w3.org/html5/websockets/">http://dev.w3.org/html5/websockets/</a></span><span>)</span></li><li class="c5 c0"><span>jQuery is at 1.7.2</span></li></ol><h1 class="c0"><a name="h.ugnpsyekvw33"></a><span>Basic Web Page</span></h1><p class="c0"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p class="c0"><span>First we will develop a basic web page without any support for WebSocket. It will not do much, but will demonstrate the basic structure of the page, script, style, and Go program that serves the page. Once we get these out of the way, we will be able to focus on the real subject of this tutorial, WebSocket.</span></p><h2 class="c0"><a name="h.vc9s3i788co6"></a><span>Directory Structure</span></h2><p class="c0"><span>Our directory structure (which will not change throughout the tutorial) is quite simple: Go code is in the root of the tree and HTML, CSS, and JavaScript files are in subdirectories html, css, and script respectively.</span></p><a href="#" name="fc414e0eca9fb2280a18553f6d03de9feda187da"></a><a href="#" name="0"></a><table cellpadding="0" cellspacing="0" class="c3"><tbody><tr><td class="c8"><p class="c0 c2"><span class="c1">/</span></p><p class="c0 c2"><span class="c1">&nbsp; css/</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; style.css</span></p><p class="c0 c2"><span class="c1">&nbsp; html/</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; index.html</span></p><p class="c0 c2"><span class="c1">&nbsp; script/</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; jquery-1.7.2.js</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; wstelnet.js</span></p><p class="c0 c2"><span class="c1">&nbsp; wstelnet.go</span></p></td></tr></tbody></table><p class="c4 c0"><span class="c1"></span></p><h2 class="c0"><a name="h.e0c1s5h35c6b"></a><span>HTML file</span></h2><p class="c0"><span>We will make this file will all sections that we will need for the telnet application, although they will not become functional until we add WebSocket support.</span></p><p class="c4 c0"><span></span></p><p class="c4 c0"><span></span></p><a href="#" name="64af478641ac430961da0f813165789ceeaa1ba7"></a><a href="#" name="1"></a><table cellpadding="0" cellspacing="0" class="c3"><tbody><tr><td class="c8"><p class="c0 c2"><span class="c1">&lt;html&gt;</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">&lt;head&gt;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; &lt;title&gt;WebSocket tutorial&lt;/title&gt;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;css/style.css&quot;/&gt;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; &lt;script type=&quot;text/JavaScript&quot; src=&quot;script/jquery-1.7.2.js&quot;&gt;&lt;/script&gt;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; </span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; &lt;script type=&quot;text/JavaScript&quot; src=&quot;script/wstelnet.js&quot;&gt;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; &lt;/script&gt;</span></p><p class="c0 c2"><span class="c1">&lt;/head&gt;</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">&lt;body&gt;</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">&lt;div id=&quot;connect&quot;&gt;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; &lt;div&gt;Host: &lt;input type=&quot;text&quot; value=&quot;&quot; name=&quot;host&quot; id=&quot;host&quot;/&gt;&lt;/div&gt;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; &lt;div&gt;Port: &lt;input type=&quot;text&quot; value=&quot;&quot; name=&quot;port&quot; id=&quot;port&quot;/&gt;&lt;/div&gt;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; &lt;div&gt;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;input type=&quot;button&quot; value=&quot;Connect&quot; id=&quot;connect-button&quot; /&gt;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;div id=&quot;status&quot;&gt;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Disconnected</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/div&gt;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; &lt;/div&gt;</span></p><p class="c0 c2"><span class="c1">&lt;/div&gt;</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">&lt;div id=&quot;console&quot;&gt;</span></p><p class="c0 c2"><span class="c1">&lt;/div&gt;</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">&lt;div id=&quot;input-box&quot;&gt;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; &lt;div&gt;&lt;input type=&quot;text&quot; value=&quot;&quot; name=&quot;command&quot; id=&quot;command&quot;/&gt;&lt;/div&gt;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; &lt;div&gt;&lt;input type=&quot;button&quot; value=&quot;Send&quot; id=&quot;send-button&quot; /&gt;&lt;/div&gt;</span></p><p class="c0 c2"><span class="c1">&lt;/div&gt;</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">&lt;/body&gt;</span></p><p class="c0 c2"><span class="c1">&lt;/html&gt;</span></p><p class="c4 c0 c2"><span class="c1"></span></p></td></tr></tbody></table><p class="c4 c0"><span></span></p><p class="c0"><span>Here&rsquo;s what it looks like in Chrome:</span></p><p class="c4 c0"><span></span></p><p class="c0"><img height="407" src="images/image00.png" width="675"></p><h2 class="c0"><a name="h.oa657nt8q9w0"></a><span>CSS File</span></h2><p class="c0"><span>This file is very simple:</span></p><p class="c4 c0"><span></span></p><a href="#" name="fa0d685ce86cd6defd4f429821affa8857c27eed"></a><a href="#" name="2"></a><table cellpadding="0" cellspacing="0" class="c3"><tbody><tr><td class="c8"><p class="c0 c2"><span class="c1">#console {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; background-color: #aaaaaa;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; width: 40em;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; height: 15em;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; overflow: auto;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; border: 1px solid;</span></p><p class="c0 c2"><span class="c1">}</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">.output {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; color: blue;</span></p><p class="c0 c2"><span class="c1">}</span></p><p class="c4 c0 c2"><span class="c1"></span></p></td></tr></tbody></table><p class="c4 c0"><span></span></p><p class="c0"><span>We only define two styles:</span></p><ol class="c7" start="1"><li class="c5 c0"><span>console is the ID of the console area where we will show user&rsquo;s commands and server&rsquo;s messages</span></li><li class="c5 c0"><span>output is the class for user&rsquo;s commands in the console area; we want to display them</span></li></ol><p class="c4 c0"><span></span></p><h2 class="c0"><a name="h.eda0rcn6dj99"></a><span>JavaScript File</span></h2><p class="c0"><span>The script is also simple and for now doesn&rsquo;t do much:</span></p><p class="c4 c0"><span></span></p><p class="c4 c0"><span></span></p><a href="#" name="b73d908ae0517e19156a003d3bcd47659e2c1a23"></a><a href="#" name="3"></a><table cellpadding="0" cellspacing="0" class="c3"><tbody><tr><td class="c8"><p class="c0 c2"><span class="c1">var host;</span></p><p class="c0 c2"><span class="c1">var port;</span></p><p class="c0 c2"><span class="c1">var service; // host:port</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">$(function () {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; </span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; $(&quot;#connect-button&quot;).click(function () {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; alert(&quot;You clicked &#39;Connect&#39;&quot;);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SetStatus(&quot;Connecting&quot;);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; });</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; </span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; function SetStatus(str) {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $(&quot;#status&quot;).text(str);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; }</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; function htmlEncode(value){</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return $(&#39;&lt;div/&gt;&#39;).text(value).html();</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; }</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; function SendMessage(message) {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SetStatus(&quot;Sending message: &quot; + message);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&quot;Sending message: &quot; + message);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $(&quot;#command&quot;).val(&quot;&quot;);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $(&quot;#console&quot;).append(&quot;&lt;div class=\&quot;output\&quot;&gt;&quot; + htmlEncode(message) + &quot;&lt;/div&gt;&quot;);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; </span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; $(&quot;#send-button&quot;).click(function () {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var message = $(&quot;#command&quot;).val();</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SendMessage(message);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; });</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; </span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; $(&quot;#command&quot;).keypress(function (event) {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (event.which == 13) { // Enter key</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var message = $(&quot;#command&quot;).val();</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SendMessage(message);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; });</span></p><p class="c0 c2"><span class="c1">});</span></p><p class="c4 c0 c2"><span class="c1"></span></p></td></tr></tbody></table><p class="c4 c0"><span></span></p><p class="c0"><span>This code does not yet connect to anything. It reacts to clicks to Connect and Send and to the user pressing Enter in the input element with id=command. We will add functionality in the next section.</span></p><h2 class="c0"><a name="h.i2jfvacvmq7"></a><span>Go Program</span></h2><p class="c0"><span>The Go program that runs on the server side is this:</span></p><p class="c4 c0"><span></span></p><a href="#" name="f8a928cab7c085caefeb74c03e026c3e79e3dcff"></a><a href="#" name="4"></a><table cellpadding="0" cellspacing="0" class="c3"><tbody><tr><td class="c8"><p class="c0 c2"><span class="c1">package main</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">import (</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; &quot;fmt&quot;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; &quot;net/http&quot;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; &quot;os&quot;</span></p><p class="c0 c2"><span class="c1">)</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">func main() {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; if len(os.Args) != 2 {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fmt.Println(&quot;Usage: wstelnet port&quot;)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; os.Exit(0)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; </span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; port := os.Args[1]</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; fmt.Println(&quot;Serving web on port&quot;, port)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; service := &quot;:&quot; + port</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; </span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; http.Handle(&quot;/script/&quot;, http.FileServer(http.Dir(&quot;.&quot;)))</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; http.Handle(&quot;/css/&quot;, http.FileServer(http.Dir(&quot;.&quot;)))</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; http.Handle(&quot;/&quot;, http.FileServer(http.Dir(&quot;./html/&quot;)))</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; err := http.ListenAndServe(service, nil)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; checkError(err)</span></p><p class="c0 c2"><span class="c1">}</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">func checkError(err error) {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; if err != nil {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fmt.Println(&quot;Fatal error &quot;, err.Error())</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; os.Exit(1)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; }</span></p><p class="c0 c2"><span class="c1">}</span></p><p class="c4 c0 c2"><span class="c1"></span></p></td></tr></tbody></table><p class="c4 c0"><span></span></p><p class="c0"><span>This code reads port number from the command line, sets up handlers for serving scripts, CSS and HTML files and runs HTTP server. I made the port configurable by the user, because the standard port 80 for HTTP may be used already by the machine&rsquo;s web server and because the user&rsquo;s account would require administrator privileges to listen on port 80 anyway.</span></p><h1 class="c0"><a name="h.ujqgjc9q978b"></a><span>WebSocket Application</span></h1><p class="c0"><span>Now we will add the functionality to serve web sockets. The HTML file that we wrote for the first phase will not change at all. The change is in the script on the client (browser) side and in the Go program on the server side.</span></p><h2 class="c0"><a name="h.f4b9p82gx5hb"></a><span>JavaScript changes</span></h2><p class="c0"><span>When the user clicks on Connect button, we create a WebSocket object:</span></p><p class="c4 c0"><span class="c1"></span></p><p class="c0"><span class="c1">ws = new WebSocket(&quot;ws://localhost:8000/websocket/ws&quot;);</span></p><p class="c4 c0"><span></span></p><p class="c0"><span>This call will cause the browser to try to establish a web socket with the server. Since this happens asynchronously, the browser will communicate with our script through callbacks. For the WebSocket object, there are four standard callbacks that our script has to implement: onopen, onerror, onmessage, and onclose.</span></p><p class="c0"><span>Since we use a web socket to communicate with a server that provides some service, there will always be a protocol that defines the communication between the browser and the server. In our case this protocol is very simple: the first message the script sends on an open web socket is the host and port that our server should connect to: for example, yahoo.com:80. Then the server tries to connect to the remote host and sends back string &ldquo;SUCC&rdquo; if successful and &ldquo;FAIL:&lt;reason&gt;&rdquo; otherwise. Our JavaScript script will watch for this response. If it sees &ldquo;SUCC&rdquo; then the connect was successful and for the rest of the life of the web socket it sends messages to and receives them from the remote host.</span></p><p class="c0"><span>Let&rsquo;s see how this is implemented in the script. First, there is global variable status that keeps the status of the web socket:</span></p><p class="c4 c0"><span></span></p><p class="c0"><span class="c1">var status; // &quot;DISCONNECTED&quot;, &quot;CONNECTING&quot;, &quot;CONNECTED&quot;</span></p><p class="c4 c0"><span></span></p><p class="c0"><span>In the code that follows we use function SetStatus to set the status text:</span></p><p class="c4 c0"><span></span></p><p class="c4 c0"><span></span></p><a href="#" name="c30f34c29223744dd10d83473bd9c68354201cee"></a><a href="#" name="5"></a><table cellpadding="0" cellspacing="0" class="c3"><tbody><tr><td class="c8"><p class="c0 c2"><span class="c1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;function SetStatus(str) {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $(&quot;#status&quot;).text(str);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; }</span></p><p class="c4 c0 c2"><span class="c1"></span></p></td></tr></tbody></table><p class="c4 c0"><span></span></p><p class="c4 c0"><span></span></p><p class="c0"><span>Now we show the four callbacks of the WebSocket object:</span></p><p class="c4 c0"><span></span></p><p class="c0 c6"><span class="c1">ws.onopen = function (event) {</span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&quot;onopen: service=&quot; + service);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SetStatus(&quot;Connecting&quot;);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; status = &quot;CONNECTING&quot;;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ws.send(service);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c4 c0"><span></span></p><p class="c0"><span>After the web socket is open, the script sets status to &ldquo;CONNECTING&rdquo; and sends service (host:port).</span></p><p class="c4 c0"><span></span></p><p class="c0 c6"><span class="c1">ws.onerror = function (event) {</span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&quot;onerror&quot;);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; status = &quot;DISCONNECTED&quot;;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ws.close();</span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ws = null;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c4"><span></span></p><p class="c0"><span>In case of and error, we set status to &ldquo;DISCONNECTED&rdquo;, close the web socket and set ws to null.</span></p><p class="c4 c0"><span></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ws.onmessage = function (event) {</span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (status == &quot;CONNECTED&quot;) {</span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&quot;onmessage: &quot; + event.data);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $(&quot;#console&quot;).append(&quot;&lt;div&gt;&quot; + htmlEncode(event.data) + &quot;&lt;/div&gt;&quot;);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else {</span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (event.data == &quot;SUCC&quot;) {</span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; status = &quot;CONNECTED&quot;;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SetStatus(&quot;Connected&quot;);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else {</span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; status = &quot;DISCONNECTED&quot;;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SetStatus(&quot;Disconnected: &quot; + event.data);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ws.close();</span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ws = null;</span></p><p class="c4 c0"><span class="c1"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c4 c0"><span class="c1"></span></p><p class="c0"><span>If status is &ldquo;CONNECTED&rdquo;, the connection with the remote host has been established and the message we recived via the call of onmessage is just appended to the contents of the element with id=&rdquo;console&rdquo;.</span></p><p class="c0"><span>Otherwise, the status is &ldquo;CONNECTING&rdquo; and the script has to check if the received message is &ldquo;SUCC&rdquo;. If so, the connection has just been established and we set status to &ldquo;CONNECTED&rdquo;. If not, then the message will follow the pattern &ldquo;FAIL:reason&rdquo; where reason is the error string (we will see where this comes from on the Go server side). This message is written to the status line, status is set to &ldquo;DISCONNECTED&rdquo; and we close the web socket and set ws to null.</span></p><p class="c4 c0"><span></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ws.onclose = function (event) {</span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&quot;onclose&quot;);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SetStatus(&quot;Disconnected&quot;);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; status = &quot;DISCONNECTED&quot;;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ws.close();</span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ws = null;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c4 c0"><span></span></p><p class="c0"><span>This code should by now be clear: if the server closed the connection, we set the status to &ldquo;DISCONNECTED&rdquo;, close our side of the web socket and set ws to null.</span></p><p class="c0"><span>We send messages to the web socket server by calling function SendMessage:</span></p><p class="c4 c0"><span></span></p><p class="c4 c0"><span></span></p><a href="#" name="c6a2877a838d98153bc8ee772f2fcc9da8a4790c"></a><a href="#" name="6"></a><table cellpadding="0" cellspacing="0" class="c3"><tbody><tr><td class="c8"><p class="c0 c2"><span class="c1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;function SendMessage(message) {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&quot;Sending message: &quot; + message);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ws.send(message);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $(&quot;#command&quot;).val(&quot;&quot;);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var dom = $(&quot;&lt;div&gt;&quot;);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dom.find(&quot;div&quot;).append(message);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $(&quot;#console&quot;).append(&quot;&lt;div class=\&quot;output\&quot;&gt;&quot; + htmlEncode(message) + &quot;&lt;/div&gt;&quot;);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; }</span></p><p class="c4 c0 c2"><span class="c1"></span></p></td></tr></tbody></table><p class="c4 c0"><span></span></p><p class="c0"><span>In addition to sending message by calling ws.send(message), this function also appends the message to the contents of console area (and sets the class of the appended div to output, which will render it in blue color).</span></p><p class="c0"><span>Function SendMessage is call from two locations: when the user clicks on the Send button and when the user presses Enter in the input box:</span></p><p class="c4 c0"><span></span></p><a href="#" name="35f81ac97d68a5e32a71778449408bfcaa89cc01"></a><a href="#" name="7"></a><table cellpadding="0" cellspacing="0" class="c3"><tbody><tr><td class="c8"><p class="c0 c2"><span class="c1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$(&quot;#send-button&quot;).click(function () {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var message = $(&quot;#command&quot;).val();</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SendMessage(message);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; });</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; </span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; $(&quot;#command&quot;).keypress(function (event) {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (event.which == 13) { // Enter key</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var message = $(&quot;#command&quot;).val();</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SendMessage(message);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; });</span></p><p class="c4 c0 c2"><span class="c1"></span></p></td></tr></tbody></table><p class="c4 c0"><span></span></p><p class="c0"><span>Here is the complete wstelnet.js file:</span></p><p class="c4 c0"><span></span></p><p class="c4 c0"><span></span></p><a href="#" name="7549279dc058b9fdbefa06671e942ccf287839c5"></a><a href="#" name="8"></a><table cellpadding="0" cellspacing="0" class="c3"><tbody><tr><td class="c8"><p class="c0 c2"><span class="c1">var ws; // WebSocket connection</span></p><p class="c0 c2"><span class="c1">var conn; // TCP connection</span></p><p class="c0 c2"><span class="c1">var host;</span></p><p class="c0 c2"><span class="c1">var port;</span></p><p class="c0 c2"><span class="c1">var service; // host:port</span></p><p class="c0 c2"><span class="c1">var status; // &quot;DISCONNECTED&quot;, &quot;CONNECTING&quot;, &quot;CONNECTED&quot;</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">$(function () {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; $(&quot;#connect-button&quot;).click(function () {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; status = &quot;DISCONNECTED&quot;;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; host = $(&quot;#host&quot;).val();</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; port = $(&quot;#port&quot;).val();</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ((port == null) || (port == &quot;&quot;)) {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; port = &quot;80&quot;;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (ws != null) {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ws.close();</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; service = host + &quot;:&quot; + port;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ws = new WebSocket(&quot;ws://localhost:8000/websocket/ws&quot;);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (ws == null) {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&quot;WebSocket creation failed&quot;);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&quot;WebSocket creation succeeded&quot;);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $(&quot;#console&quot;).text(&quot;&quot;);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ws.onopen = function (event) {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&quot;onopen: service=&quot; + service);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SetStatus(&quot;Connecting&quot;);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; status = &quot;CONNECTING&quot;;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ws.send(service);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ws.onerror = function (event) {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&quot;onerror&quot;);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; status = &quot;DISCONNECTED&quot;;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ws.close();</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ws = null;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ws.onmessage = function (event) {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (status == &quot;CONNECTED&quot;) {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&quot;onmessage: &quot; + event.data);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $(&quot;#console&quot;).append(&quot;&lt;div&gt;&quot; + htmlEncode(event.data) + &quot;&lt;/div&gt;&quot;);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (event.data == &quot;SUCC&quot;) {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; status = &quot;CONNECTED&quot;;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SetStatus(&quot;Connected&quot;);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; status = &quot;DISCONNECTED&quot;;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SetStatus(&quot;Disconnected: &quot; + event.data);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ws.close();</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ws = null;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ws.onclose = function (event) {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&quot;onclose&quot;);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SetStatus(&quot;Disconnected&quot;);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; status = &quot;DISCONNECTED&quot;;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ws.close();</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ws = null;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; });</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; </span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; function SetStatus(str) {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $(&quot;#status&quot;).text(str);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; </span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; function htmlEncode(value){</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return $(&#39;&lt;div/&gt;&#39;).text(value).html();</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; }</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; function SendMessage(message) {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&quot;Sending message: &quot; + message);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ws.send(message);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $(&quot;#command&quot;).val(&quot;&quot;);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var dom = $(&quot;&lt;div&gt;&quot;);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dom.find(&quot;div&quot;).append(message);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&quot;SendMessage: dom is &quot; + dom.html());</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $(&quot;#console&quot;).append(&quot;&lt;div class=\&quot;output\&quot;&gt;&quot; + htmlEncode(message) + &quot;&lt;/div&gt;&quot;);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; </span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; $(&quot;#send-button&quot;).click(function () {</span></p><p class="c0 c2"><span class="c1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var message = $(&quot;#command&quot;).val();</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SendMessage(message);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; });</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; </span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; $(&quot;#command&quot;).keypress(function (event) {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (event.which == 13) { // Enter key</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var message = $(&quot;#command&quot;).val();</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SendMessage(message);</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; });</span></p><p class="c0 c2"><span class="c1">});</span></p><p class="c4 c0 c2"><span class="c1"></span></p></td></tr></tbody></table><p class="c4 c0"><span></span></p><h2 class="c0"><a name="h.5awhm03ip3ra"></a><span>Go code changes</span></h2><p class="c0"><span>The Go code has to handle a web socket. First, we register the handler:</span></p><p class="c4 c0"><span></span></p><p class="c0"><span class="c1">http.Handle(&quot;/websocket/&quot;, websocket.Handler(ProcessSocket))</span></p><p class="c4 c0"><span></span></p><p class="c0"><span>The function ProcessSocket is as follows:</span></p><p class="c4 c0"><span></span></p><p class="c4 c0"><span></span></p><a href="#" name="4a66d44cdefb73c8159626107c860f6419adb466"></a><a href="#" name="9"></a><table cellpadding="0" cellspacing="0" class="c3"><tbody><tr><td class="c8"><p class="c0 c2"><span class="c1">func ProcessSocket(ws *websocket.Conn) {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; fmt.Println(&quot;In ProcessSocket&quot;)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; var msg string</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; err := websocket.Message.Receive(ws, &amp;msg)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; if err != nil {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fmt.Println(&quot;ProcessSocket: got error&quot;, err)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _ = websocket.Message.Send(ws, &quot;FAIL:&quot; + err.Error())</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; fmt.Println(&quot;ProcessSocket: got message&quot;, msg)</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; service := msg</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; </span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; tcpAddr, err := net.ResolveTCPAddr(&quot;tcp&quot;, service)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; if err != nil {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fmt.Println(&quot;Error in ResolveTCPAddr:&quot;, err)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _ = websocket.Message.Send(ws, &quot;FAIL:&quot; + err.Error())</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; </span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; conn, err := net.DialTCP(&quot;tcp&quot;, nil, tcpAddr)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; if err != nil {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fmt.Println(&quot;Error in DialTCP:&quot;, err)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _ = websocket.Message.Send(ws, &quot;FAIL:&quot; + err.Error())</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; </span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; _ = websocket.Message.Send(ws, &quot;SUCC&quot;)</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; RunTelnet(ws, conn)</span></p><p class="c0 c2"><span class="c1">}</span></p><p class="c4 c0 c2"><span class="c1"></span></p></td></tr></tbody></table><p class="c4 c0"><span></span></p><p class="c0"><span>This function receives the service string from the JavaScript script, which it expects to be in the form host:port. It resolves the host name and establishes a TCP connection. If any of these steps fails, the function send back the string &ldquo;FAIL:&lt;reason&gt;&rdquo; (where the reason is the result of err.Error()) and exits. If everything is successful, it calls RunTelnet.</span></p><p class="c0"><span>NOTE: When you implement a web socket handler function, keep in mind that this function has to be running for the duration of the life of the web socket. When this function exits, the web socket is closed. For example, this is what tripped me up: the handler cannot create a goroutine that processes the web socket and then exit, because after it exits the web socket will get closed and the goroutine will try to use an invalid web socket handle.</span></p><p class="c0"><span>Function RunTelnet starts a goroutine that will read from TCP socket and write to web socket. After that, RunTelnet runs a loop in which it reads from web socket and write to TCP socket. As mentioned in the last note, it would not work if RunTelnet just started two goroutines that serve the two directions of data transfer and then exited.</span></p><p class="c4 c0"><span></span></p><p class="c4 c0"><span></span></p><a href="#" name="f3ef990cd3f224afdda8a31b600d982d17a1eb97"></a><a href="#" name="10"></a><table cellpadding="0" cellspacing="0" class="c3"><tbody><tr><td class="c8"><p class="c0 c2"><span class="c1">func RunTelnet(ws *websocket.Conn, conn *net.TCPConn) {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; fmt.Println(&quot;Running telnet&quot;)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; go ReadSocket(ws, conn)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; </span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; // Read websocket and write to socket.</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; crlf := []byte{13, 10}</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; var msg string</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; for {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; err := websocket.Message.Receive(ws, &amp;msg)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if err != nil {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _ = conn.Close()</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _, err = conn.Write([]byte(msg))</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if err != nil {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fmt.Println(&quot;Sent message to host:&quot;, msg)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Send \r\n (as HTTP protocol requires)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _, err = conn.Write(crlf)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if err != nil {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; fmt.Println(&quot;RunTelnet exit&quot;)</span></p><p class="c0 c2"><span class="c1">}</span></p><p class="c4 c0 c2"><span class="c1"></span></p></td></tr></tbody></table><p class="c4 c0"><span></span></p><p class="c0"><span>Note how RunTelnet actually sends two messages to the remote host: the text received from the script and CR-LF (new line). We need this, because we will want to connect to HTTP servers, which expect every line to be terminated with CR-LF.</span></p><p class="c0"><span>What is left is the function ReadSocket:</span></p><p class="c4 c0"><span></span></p><p class="c4 c0"><span></span></p><a href="#" name="fb6cfd42d40ea9a09b5518411e04d33ddb51f2c9"></a><a href="#" name="11"></a><table cellpadding="0" cellspacing="0" class="c3"><tbody><tr><td class="c8"><p class="c0 c2"><span class="c1">func ReadSocket(ws *websocket.Conn, conn *net.TCPConn) {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; reader := bufio.NewReader(conn)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; var line string = &quot;&quot;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; for {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if reader == nil {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; buffer, isPrefix, err := reader.ReadLine()</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if err != nil {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // fmt.Println(&quot;ReadSocket: got&quot;, len(buffer), &quot;bytes&quot;)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; line = line + string(buffer)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if !isPrefix {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // fmt.Println(&quot;Sending message to web socket:&quot;, line)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; err = websocket.Message.Send(ws, line)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if err != nil {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _ = conn.Close()</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; line = &quot;&quot;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; fmt.Println(&quot;ReadSocket exit&quot;)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; ws.Close()</span></p><p class="c0 c2"><span class="c1">}</span></p><p class="c4 c0 c2"><span class="c1"></span></p></td></tr></tbody></table><p class="c4 c0"><span></span></p><p class="c0"><span>This function reads a line from the TCP socket in a loop and sends it to the web socket.</span></p><p class="c0"><span>For reading a line, we use Reader interface defined in the package bufio, which collects a line. We don&rsquo;t know in advance how long the line is going to be, so one of the three returned values of ReadLine is boolean isPrefix. If it is false, we know that we have collected the whole line and send it to the web socket.</span></p><p class="c0"><span>Note what happens if we detect that the remote host has closed the socket (which will always be the case with HTTP 1.0): reader.ReadLine() returns error (err != nil). We break out of the loop and close the web socket. This in turn will cause the call of ws.Message.Receive in RunTelnet to return an error and RunTelnet will exit.</span></p><p class="c0"><span>Here is the whole code of wstelnet.go:</span></p><p class="c4 c0"><span></span></p><p class="c4 c0"><span></span></p><a href="#" name="9c9c105f2bd16549c7516e0357838b58379c6ed5"></a><a href="#" name="12"></a><table cellpadding="0" cellspacing="0" class="c3"><tbody><tr><td class="c8"><p class="c0 c2"><span class="c1">package main</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">import (</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; &quot;fmt&quot;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; &quot;net/http&quot;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; &quot;os&quot;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; &quot;code.google.com/p/go.net/websocket&quot;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; &quot;bufio&quot;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; &quot;net&quot;</span></p><p class="c0 c2"><span class="c1">)</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">func main() {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; if len(os.Args) != 2 {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fmt.Println(&quot;Usage: wstelnet port&quot;)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; os.Exit(0)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; </span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; port := os.Args[1]</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; fmt.Println(&quot;Serving web on port&quot;, port)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; service := &quot;:&quot; + port</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; </span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; http.Handle(&quot;/script/&quot;, http.FileServer(http.Dir(&quot;.&quot;)))</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; http.Handle(&quot;/css/&quot;, http.FileServer(http.Dir(&quot;.&quot;)))</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; http.Handle(&quot;/&quot;, http.FileServer(http.Dir(&quot;./html/&quot;)))</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; http.Handle(&quot;/websocket/&quot;, websocket.Handler(ProcessSocket))</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; err := http.ListenAndServe(service, nil)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; checkError(err)</span></p><p class="c0 c2"><span class="c1">}</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">func ProcessSocket(ws *websocket.Conn) {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; fmt.Println(&quot;In ProcessSocket&quot;)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; var msg string</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; err := websocket.Message.Receive(ws, &amp;msg)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; if err != nil {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fmt.Println(&quot;ProcessSocket: got error&quot;, err)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _ = websocket.Message.Send(ws, &quot;FAIL:&quot; + err.Error())</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; fmt.Println(&quot;ProcessSocket: got message&quot;, msg)</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; service := msg</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; </span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; tcpAddr, err := net.ResolveTCPAddr(&quot;tcp&quot;, service)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; if err != nil {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fmt.Println(&quot;Error in ResolveTCPAddr:&quot;, err)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _ = websocket.Message.Send(ws, &quot;FAIL:&quot; + err.Error())</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; </span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; conn, err := net.DialTCP(&quot;tcp&quot;, nil, tcpAddr)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; if err != nil {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fmt.Println(&quot;Error in DialTCP:&quot;, err)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _ = websocket.Message.Send(ws, &quot;FAIL:&quot; + err.Error())</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; </span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; _ = websocket.Message.Send(ws, &quot;SUCC&quot;)</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; RunTelnet(ws, conn)</span></p><p class="c0 c2"><span class="c1">}</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">func RunTelnet(ws *websocket.Conn, conn *net.TCPConn) {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; fmt.Println(&quot;Running telnet&quot;)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; go ReadSocket(ws, conn)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; </span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; // Read websocket and write to socket.</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; crlf := []byte{13, 10}</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; var msg string</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; for {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; err := websocket.Message.Receive(ws, &amp;msg)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if err != nil {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _ = conn.Close()</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _, err = conn.Write([]byte(msg))</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if err != nil {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fmt.Println(&quot;Sent message to host:&quot;, msg)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Send \r\n (as HTTP protocol requires)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _, err = conn.Write(crlf)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if err != nil {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; fmt.Println(&quot;RunTelnet exit&quot;)</span></p><p class="c0 c2"><span class="c1">}</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">// Read from socket and write to websocket</span></p><p class="c0 c2"><span class="c1">func ReadSocket(ws *websocket.Conn, conn *net.TCPConn) {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; reader := bufio.NewReader(conn)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; var line string = &quot;&quot;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; for {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if reader == nil {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; buffer, isPrefix, err := reader.ReadLine()</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if err != nil {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // fmt.Println(&quot;ReadSocket: got&quot;, len(buffer), &quot;bytes&quot;)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; line = line + string(buffer)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if !isPrefix {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // fmt.Println(&quot;Sending message to web socket:&quot;, line)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; err = websocket.Message.Send(ws, line)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if err != nil {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _ = conn.Close()</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; line = &quot;&quot;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; fmt.Println(&quot;ReadSocket exit&quot;)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; ws.Close()</span></p><p class="c0 c2"><span class="c1">}</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">func checkError(err error) {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; if err != nil {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fmt.Println(&quot;Fatal error &quot;, err.Error())</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; os.Exit(1)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; }</span></p><p class="c0 c2"><span class="c1">}</span></p><p class="c4 c0 c2"><span class="c1"></span></p></td></tr></tbody></table><p class="c4 c0"><span></span></p><h2 class="c0"><a name="h.m0a81sf8zt05"></a><span>Trying out the code</span></h2><p class="c0"><span>Let&rsquo;s see how we can use this code to connect to a web server.</span></p><ol class="c13" start="1"><li class="c5 c0"><span>Start web server<br></span><span class="c1">go run wstelnet.go 8000</span><span><br>We can start the Go code without explicitly compiling it, or alternatively we can build the executable and then run it.</span></li><li class="c5 c0"><span>Open the page in a browser that supports WebSocket.<br></span><span class="c1">http://localhost:8000</span><span><br>If both the browser and the server are on the same machine, then we can access the server by specifying localhost.</span></li><li class="c5 c0"><span>In the Host: box type google.com.</span></li><li class="c5 c0"><span>Leave Port: box empty (the default is 80, the standard HTTP port).</span></li><li class="c5 c0"><span>Click Connect. If we are successful, the status message will change to &ldquo;Connected&rdquo;.</span></li><li class="c5 c0"><span>In the input box above Send button, type<br></span><span class="c1">GET / HTTP/1.0</span></li><li class="c5 c0"><span>Press Enter. The message is sent to the web server and also displayed in the console area.</span></li><li class="c5 c0"><span>Press Enter again. When the web server (google.com in our example) receives the second CR-LF, it will respond with its default web page. Because I am doing it from Canada, I get a redirect page with response code 302 Found:<br></span><span class="c1 c11">HTTP/1.0 302 Found<br>Location: http://www.google.ca/<br>Cache-Control: private<br>Content-Type: text/html; charset=UTF-8</span></li><li class="c5 c0"><span>Because we used HTTP 1.0, the web server immediately closes the connection after it finishes sending the page. On our web page, the status line is changed to &ldquo;Disconnected&rdquo;.</span></li></ol><h1 class="c0"><a name="h.m276moi2jfet"></a><span>Test Server</span></h1><p class="c0"><span>In order to show that this way we can connect to any server that exchanges text messages over TCP, we can use a simple Go application that echoes received messages back to the client. If it receives a text message that starts with &ldquo;quit,&rdquo; it will close the connection. That will enable us to experiment with different scenarios.</span></p><p class="c0"><span>Here&rsquo;s the whole code. It is very simple:</span></p><p class="c4 c0"><span></span></p><a href="#" name="e4b7f07c7c1c95e9be6198329510b40e19b460f0"></a><a href="#" name="13"></a><table cellpadding="0" cellspacing="0" class="c3"><tbody><tr><td class="c8"><p class="c0 c2"><span class="c1">package main</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">import (</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; &quot;fmt&quot;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; &quot;os&quot;</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; &quot;net&quot;</span></p><p class="c0 c2"><span class="c1">)</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">func main() {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; fmt.Println(&quot;hello responder&quot;)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; fmt.Println(&quot;you supplied&quot;, len(os.Args), &quot;arguments&quot;)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; if len(os.Args) != 2 {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fmt.Println(&quot;Usage: responder &lt;port&gt;&quot;)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; os.Exit(0)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; port := os.Args[1]</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; fmt.Println(&quot;Port:&quot;, port)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; </span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; service := &quot;:&quot; + port</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; tcpAddr, err := net.ResolveTCPAddr(&quot;ip4&quot;, service)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; checkError(err)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; fmt.Println(&quot;Resolved TCP address for the service&quot;)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; </span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; listener, err := net.ListenTCP(&quot;tcp&quot;, tcpAddr)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; checkError(err)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; </span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; for {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; conn, err := listener.AcceptTCP()</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if err != nil {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; continue</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; go ServeSocket(conn)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; }</span></p><p class="c0 c2"><span class="c1">}</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">func ServeSocket(conn *net.TCPConn) {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; fmt.Println(&quot;In ServeSocket&quot;)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; for {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var buffer [512]byte</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; n, err := conn.Read(buffer[:])</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if err != nil {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; message := string(buffer[:n])</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fmt.Println(&quot;Got message:&quot;, message)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if message[:4] == &quot;quit&quot; {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _, err = conn.Write([]byte(message))</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if err != nil {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; }</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; conn.Close()</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; fmt.Println(&quot;Connection closed&quot;)</span></p><p class="c0 c2"><span class="c1">}</span></p><p class="c4 c0 c2"><span class="c1"></span></p><p class="c0 c2"><span class="c1">func checkError(err error) {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; if err != nil {</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fmt.Fprintf(os.Stderr, &quot;Fatal error: %s&quot;, err.Error())</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; os.Exit(1)</span></p><p class="c0 c2"><span class="c1">&nbsp; &nbsp; }</span></p><p class="c0 c2"><span class="c1">}</span></p><p class="c4 c0 c2"><span class="c1"></span></p></td></tr></tbody></table><p class="c0"><span>We start the echo server with a command like this:</span></p><p class="c4 c0"><span></span></p><p class="c0"><span class="c1">go run echoserver.go 4000</span></p><p class="c4 c0"><span></span></p><p class="c0"><span>and, assuming that it is running on the same machine as the web server, we connect to it from the web page by specifying host localhost and port 4000. Then we can type messages in the input box and after we press Enter see them echoed. When we want to finish, we type &ldquo;quit&rdquo; (without quotes) and press Enter and we see the status line changed to &ldquo;Disconnected.&rdquo;</span></p><h2 class="c0"><a name="h.a8liwbf33z4a"></a><span>Exercise for the Reader</span></h2><p class="c0"><span>We don&rsquo;t have a disconnect button on the web page. Add that button and the code in the script that will close the web socket when the user clicks on the button.</span></p><p class="c4 c0"><span></span></p><p class="c4 c0"><span></span></p><p class="c4 c0"><span></span></p></body></html>